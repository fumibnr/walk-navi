<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é™ç•Œçªç ´ãƒŠãƒ“ å®Œå…¨ç‰ˆ</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
html,body,#map{margin:0;height:100%}
#ui{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:white;padding:8px;border-radius:14px;z-index:10;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
#ui input{font-size:16px;padding:6px;width:180px}
#ui button{font-size:15px;margin-left:4px}
#viewMode,#routeSelect{display:flex;margin-top:6px}
#viewMode button,#routeSelect button{
  flex:1;margin:0 2px;border-radius:8px
}
#locBtn{
  position:absolute;bottom:20px;right:16px;width:60px;height:60px;
  border-radius:50%;border:none;background:black;color:white;font-size:28px;
  box-shadow:0 2px 6px rgba(0,0,0,.4);z-index:10;
}
#info{
  position:absolute;bottom:90px;left:50%;transform:translateX(-50%);
  background:white;padding:10px 14px;border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  display:none;z-index:10;font-size:15px;
}
</style>
</head>
<body>
<div id="map"></div>

<div id="ui">
  <input id="searchInput" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›">
  <button onclick="search()">ğŸ”æ¤œç´¢</button>
  
  <div id="viewMode">
    <button onclick="setView('2d')">2D</button>
    <button onclick="setView('2dn')">2DN</button>
    <button onclick="setView('3d')">3D</button>
  </div>

  <div id="routeSelect" style="display:none;">
    <button onclick="startNav('foot-walking')">å¾’æ­©</button>
    <button onclick="startNav('driving-car')">è»Š</button>
    <button onclick="startNav(currentProfile)">ãƒŠãƒ“é–‹å§‹</button>
  </div>
</div>

<button id="locBtn" onclick="goCurrent()">âŒ–</button>
<div id="info"></div>

<script>
const ORS_API_KEY = "ã“ã“ã«APIã‚­ãƒ¼";
const map = new maplibregl.Map({
  container:'map',
  style:'https://tiles.openfreemap.org/styles/liberty',
  center:[139.767,35.681],
  zoom:15
});
map.doubleClickZoom.disable();

let current=null, currentHeading=0;
let dest=null, destMarker=null;
let currentProfile='foot-walking';
let viewMode='2d';

/* ===== GPSè¿½å¾“ ===== */
navigator.geolocation.watchPosition(p=>{
  current=[p.coords.longitude,p.coords.latitude];
  currentHeading=p.coords.heading ?? currentHeading;
},e=>console.log(e),{enableHighAccuracy:true});

/* ===== ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ ===== */
function goCurrent(){ if(!current) return; map.easeTo({center:current,zoom:17}); }

/* ===== è¦–ç‚¹åˆ‡æ›¿ ===== */
function setView(mode){
  viewMode = mode;
  if(mode==='2d') map.setPitch(0), map.setBearing(0);
  if(mode==='2dn') map.setPitch(0), map.setBearing(0);
  if(mode==='3d') map.setPitch(60), map.setBearing(currentHeading), enable3DBuildings();
}

/* ===== 3Då»ºç‰© ===== */
let buildingsAdded=false;
function enable3DBuildings(){
  if(buildingsAdded) return;
  map.addLayer({
    id:'3d-buildings',
    source:'openmaptiles',
    'source-layer':'building',
    type:'fill-extrusion',
    minzoom:15,
    paint:{
      'fill-extrusion-color':'#aaa',
      'fill-extrusion-height':['coalesce',['get','height'],10],
      'fill-extrusion-base':['coalesce',['get','min_height'],0],
      'fill-extrusion-opacity':0.6
    }
  });
  buildingsAdded=true;
}

/* ===== æ¤œç´¢ ===== */
function search(){
  const query = document.getElementById("searchInput").value;
  fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d.features[0]) return alert("è¦‹ã¤ã‹ã‚‰ãªã„ğŸ˜‡");
    const [lng,lat]=d.features[0].geometry.coordinates;
    setDest([lng,lat]);
  });
}

/* ===== ç›®çš„åœ°è¨­å®š ===== */
function setDest(coord){
  dest=coord;
  if(destMarker) destMarker.remove();
  destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
  map.easeTo({center:dest,zoom:16});
  document.getElementById('routeSelect').style.display='flex'; // ãƒœã‚¿ãƒ³è¡¨ç¤º
}

/* ===== ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç›®çš„åœ° ===== */
let lastTap=0;
map.on('touchend',e=>{
  const now=Date.now();
  if(now-lastTap<400){
    const touch = e.changedTouches[0];
    const bbox = map.getContainer().getBoundingClientRect();
    const lngLat = map.unproject([touch.clientX-bbox.left,touch.clientY-bbox.top]);
    setDest([lngLat.lng,lngLat.lat]);
  }
  lastTap=now;
});

/* ===== ãƒŠãƒ“é–‹å§‹ ===== */
function startNav(profile){
  if(!dest || !current) return;
  currentProfile=profile;
  fetch(`https://api.openrouteservice.org/v2/directions/${profile}`,{
    method:'POST',
    headers:{'Authorization':ORS_API_KEY,'Content-Type':'application/json'},
    body:JSON.stringify({coordinates:[current,dest]})
  }).then(r=>r.json()).then(d=>{
    const route=d.features[0];
    if(map.getSource('route')) map.removeLayer('route'), map.removeSource('route');
    map.addSource('route',{type:'geojson',data:route});
    map.addLayer({id:'route',type:'line',source:'route',paint:{'line-width':6,'line-color':'#1e90ff','line-offset':2}});
    document.getElementById('info').innerText=`è·é›¢ ${(route.properties.summary.distance/1000).toFixed(1)}km / ç´„ ${Math.round(route.properties.summary.duration/60)}åˆ†`;
    document.getElementById('info').style.display='block';
    trackPositionForVoice(route.geometry.coordinates);
  });
}

/* ===== éŸ³å£°ãƒŠãƒ“ ===== */
function speak(text){
  if('speechSynthesis' in window){
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang='ja-JP';
    window.speechSynthesis.speak(msg);
  }
}

/* ===== ãƒ«ãƒ¼ãƒˆè¿½å¾“ï¼†éŸ³å£° ===== */
let lastVoiceIndex=-1;
function trackPositionForVoice(coords){
  lastVoiceIndex=-1;
  const interval=setInterval(()=>{
    if(!current) return;
    let nextIndex=coords.findIndex((c,i)=>i>lastVoiceIndex && distance(current,c)>0);
    if(nextIndex===-1){ clearInterval(interval); return; }
    const dist=distance(current, coords[nextIndex]);
    if(dist<50 && nextIndex>lastVoiceIndex){ speak(`${Math.round(dist)}ãƒ¡ãƒ¼ãƒˆãƒ«å…ˆã€æ›²ãŒã‚Šè§’ã§ã™`); lastVoiceIndex=nextIndex; }
  },1000);
}

/* ===== è·é›¢è¨ˆç®— ===== */
function distance(a,b){
  const R=6371000, rad=Math.PI/180;
  const dLat=(b[1]-a[1])*rad, dLon=(b[0]-a[0])*rad;
  const lat1=a[1]*rad, lat2=b[1]*rad;
  const x=dLon*Math.cos((lat1+lat2)/2), y=dLat;
  return Math.sqrt(x*x+y*y)*R;
}
</script>
</body>
</html>

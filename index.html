<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å®Œå…¨ç‰ˆãƒŠãƒ“ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹åˆ‡æ›¿ & APIã‚­ãƒ¼å…¥ã‚Šï¼‰</title>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<style>
html,body,#map{margin:0;height:100%;}
#ui{position:absolute;top:10px;left:50%;transform:translateX(-50%);
background:white;padding:8px;border-radius:14px;z-index:10;
box-shadow:0 4px 10px rgba(0,0,0,.3);}
#ui input{font-size:16px;padding:6px;width:180px;}
#ui button{font-size:15px;margin-left:4px;}
#routeSelect{display:none;margin-top:6px;}
#routeSelect button{flex:1;margin:0 2px;border-radius:8px;}
#saveRoute{display:none;margin-top:6px;}
#saveRoute button{flex:1;margin:0 2px;border-radius:8px;}
#locBtn{position:absolute;bottom:20px;right:16px;width:60px;height:60px;border-radius:50%;border:none;background:black;color:white;font-size:28px;box-shadow:0 2px 6px rgba(0,0,0,.4);z-index:10;}
#compassBtn{position:absolute;top:10px;right:10px;width:50px;height:50px;border-radius:50%;border:none;background:white;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:24px;z-index:10;}
#info{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);background:white;padding:10px 14px;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.3);display:none;z-index:10;font-size:15px;}
#suggestions{position:absolute;top:50px;left:50%;transform:translateX(-50%);background:white;border-radius:12px;max-height:150px;overflow:auto;z-index:11;width:200px;display:none;}
#suggestions div{padding:6px 8px;cursor:pointer;}
#suggestions div:hover{background:#eee;}
</style>
</head>
<body>
<div id="map"></div>

<div id="ui">
<input id="searchInput" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›">
<button onclick="search()">ğŸ”æ¤œç´¢</button>

<div id="routeSelect">
<button onclick="getRoutes('foot-walking')">å¾’æ­©</button>
<button onclick="getRoutes('driving-car')">è»Š</button>
</div>

<div id="saveRoute">
<button onclick="saveRouteOffline()">ãƒ«ãƒ¼ãƒˆä¿å­˜ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰</button>
</div>
</div>

<div id="suggestions"></div>
<button id="locBtn" onclick="goCurrent()">âŒ–</button>
<button id="compassBtn">ğŸ§­</button>
<div id="info"></div>

<script>
// ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’å…¥ã‚Œã¾ã—ãŸ
const ORS_API_KEY="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0ZTI4ZDE0Y2I2NTQwNzM5ZWYzMDg5YTBlNmFkNTczIiwiaCI6Im11cm11cjY0In0=";

let current=null,currentHeading=0,dest=null,destMarker=null;
let routeLines=[],selectedRoute=null,currentProfile='foot-walking',viewMode='2d',currentMarker=null,buildingsAdded=false;

/* ===== åœ°å›³åˆæœŸåŒ– ===== */
const map=new maplibregl.Map({
container:'map',
style:'https://tiles.openfreemap.org/styles/liberty',
center:[139.767,35.681],
zoom:15
});
map.doubleClickZoom.disable();

/* ===== GPSè¿½å¾“ ===== */
navigator.geolocation.watchPosition(p=>{
current=[p.coords.longitude,p.coords.latitude];
currentHeading=p.coords.heading??currentHeading;
if(!currentMarker){
  const el=document.createElement('div');
  el.style.width='20px'; el.style.height='20px'; 
  el.style.background='blue';
  el.style.borderRadius='50%';
  el.style.transform=`rotate(${currentHeading??0}deg)`;
  currentMarker=new maplibregl.Marker({element:el,rotationAlignment:"map"}).setLngLat(current).addTo(map);
}else{
  currentMarker.setLngLat(current);
  currentMarker.getElement().style.transform=`rotate(${currentHeading??0}deg)`;
}
},e=>console.error("GPSå–å¾—ã‚¨ãƒ©ãƒ¼:",e),{enableHighAccuracy:true,timeout:10000,maximumAge:0});

/* ===== ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ ===== */
function goCurrent(){
if(!current){alert("ç¾åœ¨åœ°å–å¾—ä¸­â€¦å°‘ã—å¾…ã£ã¦ãã ã•ã„");return;}
map.easeTo({center:current,zoom:17});
}

/* ===== ã‚³ãƒ³ãƒ‘ã‚¹ãƒœã‚¿ãƒ³åˆ‡æ›¿ ===== */
let viewModes = ['2d','2dn','3d']; let viewIndex=0;
document.getElementById('compassBtn').addEventListener('click',()=>{
  viewIndex=(viewIndex+1)%viewModes.length;
  setView(viewModes[viewIndex]);
});

/* ===== è¦–ç‚¹åˆ‡æ›¿ ===== */
function setView(mode){
viewMode=mode;
if(mode==='2d' || mode==='2dn'){
  map.easeTo({pitch:0,bearing:(mode==='2dn'?0:map.getBearing()),duration:800});
}
if(mode==='3d'){
  map.easeTo({pitch:60,bearing:currentHeading,duration:1500});
  enable3DBuildings();
}

/* ===== 3Då»ºç‰© ===== */
function enable3DBuildings(){
if(buildingsAdded)return;
map.addLayer({id:'3d-buildings',source:'openmaptiles','source-layer':'building',type:'fill-extrusion',minzoom:15,
paint:{'fill-extrusion-color':'#aaa','fill-extrusion-height':['coalesce',['get','height'],10],'fill-extrusion-base':['coalesce',['get','min_height'],0],'fill-extrusion-opacity':0.6}});
buildingsAdded=true;
}

/* ===== ä½æ‰€æ¤œç´¢ ===== */
function search(){
const query=document.getElementById("searchInput").value;
if(!navigator.onLine){alert("ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã¯æ¤œç´¢ã§ãã¾ã›ã‚“");return;}
fetch("https://api.openrouteservice.org/geocode/search",{
method:"POST",
headers:{"Authorization":ORS_API_KEY,"Content-Type":"application/json"},
body:JSON.stringify({text:query,size:5})
})
.then(r=>r.json())
.then(d=>{
const features=d.features;
const sug=document.getElementById('suggestions');sug.innerHTML='';
if(!features.length){alert("æ¤œç´¢ã§ãã¾ã›ã‚“");return;}
features.forEach(f=>{
const div=document.createElement('div');div.innerText=f.properties.label;
div.onclick=()=>{setDest(f.geometry.coordinates);sug.style.display='none';}
sug.appendChild(div);
});
sug.style.display='block';
}).catch(e=>alert("æ¤œç´¢ã§ãã¾ã›ã‚“"));
}

/* ===== ç›®çš„åœ°è¨­å®š ===== */
function setDest(coord){
dest=coord;if(destMarker) destMarker.remove();
destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
map.easeTo({center:dest,zoom:16});
document.getElementById('routeSelect').style.display='flex';
document.getElementById('saveRoute').style.display='none';
clearRoutes();
}

/* ===== ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç›®çš„åœ°è¨­å®š ===== */
let lastTap=0;
map.getCanvas().addEventListener('touchend',e=>{
const now=Date.now();
if(now-lastTap<500){
const touch=e.changedTouches[0];const rect=map.getBoundingClientRect();
const x=touch.clientX-rect.left,y=touch.clientY-rect.top;
const lngLat=map.unproject([x,y]);setDest([lngLat.lng,lngLat.lat]);
}
lastTap=now;
});

/* ===== è¤‡æ•°ãƒ«ãƒ¼ãƒˆå–å¾— ===== */
function getRoutes(profile){
if(!dest||!current) return;currentProfile=profile;
fetch(`https://api.openrouteservice.org/v2/directions/${profile}/geojson`,{
method:'POST',
headers:{'Authorization':ORS_API_KEY,'Content-Type':'application/json'},
body:JSON.stringify({coordinates:[current,dest],options:{alternative_routes:{target_count:3,share_factor:0.6}}})
}).then(r=>r.json()).then(d=>{
clearRoutes();routeLines=d.features;
routeLines.forEach((f,i)=>{
map.addSource('route'+i,{type:'geojson',data:f});
map.addLayer({id:'route'+i,type:'line',source:'route'+i,paint:{'line-width':4,'line-color':'#888','line-opacity':0.5}});
map.on('click','route'+i,()=>selectRoute(i));
});
document.getElementById('saveRoute').style.display='flex';
alert("ãƒ«ãƒ¼ãƒˆå€™è£œã‚’é¸æŠã—ã¦ãã ã•ã„");
});
}

/* ===== ãƒ«ãƒ¼ãƒˆé¸æŠï¼†ãƒŠãƒ“é–‹å§‹ ===== */
function clearRoutes(){routeLines.forEach((f,i)=>{if(map.getLayer('route'+i))map.removeLayer('route'+i);if(map.getSource('route'+i))map.removeSource('route'+i);});routeLines=[];selectedRoute=null;if(map.getLayer('routeSelected'))map.removeLayer('routeSelected');if(map.getSource('routeSelected'))map.removeSource('routeSelected');}
function selectRoute(i){if(selectedRoute!==null){map.removeLayer('routeSelected');map.removeSource('routeSelected');}selectedRoute=i;map.addSource('routeSelected',{type:'geojson',data:routeLines[i]});map.addLayer({id:'routeSelected',type:'line',source:'routeSelected',paint:{'line-width':6,'line-color':'#1e90ff'}});startNavSelected(routeLines[i]);saveRouteOffline();}

/* ===== ãƒŠãƒ“é–‹å§‹ ===== */
function startNavSelected(route){
const coords=route.geometry.coordinates;
document.getElementById('info').innerText=`è·é›¢ ${(route.properties.summary.distance/1000).toFixed(1)}km / ç´„ ${Math.round(route.properties.summary.duration/60)}åˆ†`;
document.getElementById('info').style.display='block';
trackPositionForVoice(coords);
}

/* ===== éŸ³å£°ãƒŠãƒ“ ===== */
function speak(text){if('speechSynthesis' in window){const msg=new SpeechSynthesisUtterance(text);msg.lang='ja-JP';window.speechSynthesis.speak(msg);}}

let lastVoiceIndex=-1;
function trackPositionForVoice(coords){
lastVoiceIndex=-1;
const interval=setInterval(()=>{
if(!current) return;
let nextIndex=coords.findIndex((c,i)=>i>lastVoiceIndex && distance(current,c)>0);
if(nextIndex===-1){clearInterval(interval);return;}
const dist=distance(current,coords[nextIndex]);
if(dist<50 && nextIndex>lastVoiceIndex){speak(`${Math.round(dist)}ãƒ¡ãƒ¼ãƒˆãƒ«å…ˆã€æ›²ãŒã‚Šè§’ã§ã™`);lastVoiceIndex=nextIndex;}
},1000);
}

/* ===== è·é›¢è¨ˆç®— ===== */
function distance(a,b){const R=6371000,rad=Math.PI/180;const dLat=(b[1]-a[1])*rad,dLon=(b[0]-a[0])*rad;const lat1=a[1]*rad,lat2=b[1]*rad;const x=dLon*Math.cos((lat1+lat2)/2),y=dLat;return Math.sqrt(x*x+y*y)*R;}

/* ===== ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ«ãƒ¼ãƒˆä¿å­˜ ===== */
function saveRouteOffline(){
if(selectedRoute===null)return;
localStorage.setItem('lastRoute',JSON.stringify(routeLines[selectedRoute]));
console.log("ãƒ«ãƒ¼ãƒˆã‚’ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ã—ã¾ã—ãŸ");
}

/* ===== ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ«ãƒ¼ãƒˆå¾©å…ƒ ===== */
window.addEventListener('load',()=>{
const saved=localStorage.getItem('lastRoute');
if(saved){
const route=JSON.parse(saved);
map.addSource('offlineRoute',{type:'geojson',data:route});
map.addLayer({id:'offlineRoute',type:'line',source:'offlineRoute',paint:{'line-width':6,'line-color':'#1e90ff'}});
}
});
</script>
</body>
</html>

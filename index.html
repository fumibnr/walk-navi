<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ãƒŠãƒ“</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}
#map {
  width: 100%;
  height: 100%;
}

/* æ¤œç´¢UI */
#searchBox {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 6px;
  border-radius: 10px;
  display: flex;
  gap: 5px;
  z-index: 10;
}
#searchInput {
  font-size: 16px;
  padding: 6px;
  width: 180px;
}
#searchBtn {
  font-size: 16px;
}

/* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
#locBtn {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: white;
  border-radius: 50%;
  padding: 12px;
  font-size: 20px;
  z-index: 10;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="searchBox">
  <input id="searchInput" placeholder="ä½æ‰€ãƒ»å ´æ‰€ã‚’å…¥åŠ›">
  <button id="searchBtn">ğŸ”</button>
</div>

<button id="locBtn">â—</button>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json', // â†ã‚«ãƒ©ãƒ¼åœ°å›³
  center: [139.767, 35.681],
  zoom: 15
});

map.addControl(new maplibregl.NavigationControl());
map.doubleClickZoom.disable();

let currentMarker;
let destMarker;

// ç¾åœ¨åœ°å–å¾—
navigator.geolocation.watchPosition(pos => {
  const lng = pos.coords.longitude;
  const lat = pos.coords.latitude;
  const heading = pos.coords.heading || 0;

  if (!currentMarker) {
    currentMarker = new maplibregl.Marker({
      color: '#1e90ff'
    }).setLngLat([lng, lat]).addTo(map);
    map.setCenter([lng, lat]);
  } else {
    currentMarker.setLngLat([lng, lat]);
  }

  map.easeTo({
    center: [lng, lat],
    bearing: heading,
    duration: 500
  });
}, err => {
  alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ã­");
}, { enableHighAccuracy: true });

// ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
document.getElementById("locBtn").onclick = () => {
  if (currentMarker) {
    map.easeTo({ center: currentMarker.getLngLat(), zoom: 17 });
  }
};

// æ¤œç´¢
document.getElementById("searchBtn").onclick = search;
document.getElementById("searchInput").addEventListener("keydown", e => {
  if (e.key === "Enter") search();
});

function search() {
  const q = searchInput.value;
  if (!q) return;

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`, {
    headers: { "Accept-Language": "ja" }
  })
  .then(r => r.json())
  .then(data => {
    if (!data[0]) {
      alert("è¦‹ã¤ã‹ã‚‰ãªã„ğŸ˜¢");
      return;
    }
    const lng = data[0].lon;
    const lat = data[0].lat;

    if (destMarker) destMarker.remove();
    destMarker = new maplibregl.Marker({ color: 'red' })
      .setLngLat([lng, lat])
      .addTo(map);

    map.easeTo({ center: [lng, lat], zoom: 16 });
  });
}

// ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ç›®çš„åœ°
map.on("dblclick", e => {
  if (destMarker) destMarker.remove();
  destMarker = new maplibregl.Marker({ color: 'red' })
    .setLngLat(e.lngLat)
    .addTo(map);
});
</script>

</body>
</html>

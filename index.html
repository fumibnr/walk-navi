<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é™ç•Œçªç ´ãƒŠãƒ“</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
html,body,#map{margin:0;height:100%}
#ui{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:white;border-radius:14px;padding:8px;z-index:10;
  box-shadow:0 4px 10px rgba(0,0,0,.3)
}
#ui input{font-size:16px;padding:6px;width:180px}
#ui button{font-size:16px}
#mode{
  display:none;margin-top:6px;text-align:center
}
#mode button{margin:0 6px}

#info{
  position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
  background:white;padding:10px 14px;border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  display:none;z-index:10;font-size:15px
}

#locBtn{
  position:absolute;bottom:20px;right:16px;
  width:48px;height:48px;border-radius:50%;
  border:none;background:white;font-size:22px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);z-index:10
}
</style>
</head>

<body>
<div id="map"></div>

<div id="ui">
  <input id="searchInput" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›">
  <button onclick="search()">ğŸ”</button>
  <div id="mode">
    <button onclick="route('foot-walking')">ğŸš¶</button>
    <button onclick="route('driving-car')">ğŸš—</button>
  </div>
</div>

<div id="info"></div>
<button id="locBtn" onclick="goCurrent()">âŒ–</button>

<script>
const ORS_API_KEY = "ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼";

const map = new maplibregl.Map({
  container:'map',
  style:'https://tiles.openfreemap.org/styles/liberty',
  center:[139.767,35.681],
  zoom:15
});
map.doubleClickZoom.disable();

let current=[139.767,35.681];
let dest=null;

navigator.geolocation.watchPosition(p=>{
  current=[p.coords.longitude,p.coords.latitude];
  map.easeTo({center:current,bearing:p.coords.heading||0,duration:500});
},{},{enableHighAccuracy:true});

function goCurrent(){
  map.easeTo({center:current,zoom:17});
}

let destMarker;
function search(){
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchInput.value)}`)
  .then(r=>r.json()).then(d=>{
    if(!d[0])return alert("è¦‹ã¤ã‹ã‚‰ã‚“ğŸ˜‡");
    dest=[+d[0].lon,+d[0].lat];
    if(destMarker)destMarker.remove();
    destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
    map.easeTo({center:dest,zoom:16});
    document.getElementById("mode").style.display="block";
  });
}

map.on("dblclick",e=>{
  dest=[e.lngLat.lng,e.lngLat.lat];
  if(destMarker)destMarker.remove();
  destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
  document.getElementById("mode").style.display="block";
});

function route(profile){
  fetch("https://api.openrouteservice.org/v2/directions/"+profile,{
    method:"POST",
    headers:{
      "Authorization":ORS_API_KEY,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({coordinates:[current,dest],alternative_routes:{share_factor:0.6,target_count:2}})
  })
  .then(r=>r.json()).then(d=>{
    if(map.getSource("route")){
      map.removeLayer("route");map.removeSource("route");
    }
    map.addSource("route",{type:"geojson",data:d});
    map.addLayer({
      id:"route",type:"line",source:"route",
      paint:{
        "line-width":6,
        "line-color":["get","recommended"]
      }
    });
    const s=d.features[0].properties.summary;
    info.innerText=`è·é›¢ ${(s.distance/1000).toFixed(1)}km / ç´„ ${Math.round(s.duration/60)}åˆ†`;
    info.style.display="block";
  });
}
</script>
</body>
</html>

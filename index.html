<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>é™ç•Œçªç ´3DéŸ³å£°ãƒŠãƒ“</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
html,body,#map{margin:0;height:100%}

/* ä¸ŠUI */
#ui{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:8px;
  border-radius:14px;
  z-index:10;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
}
#ui input{font-size:16px;padding:6px;width:180px}
#ui button{font-size:15px;margin-left:4px}

/* è¦–ç‚¹åˆ‡æ›¿ */
#viewMode{
  display:flex;
  margin-top:6px;
}
#viewMode button{
  flex:1;
  margin:0 2px;
  border-radius:8px;
}

/* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
#locBtn{
  position:absolute;
  bottom:20px;
  right:16px;
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:white;
  font-size:22px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  z-index:10;
}

/* è·é›¢è¡¨ç¤º */
#info{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:10px 14px;
  border-radius:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  display:none;
  z-index:10;
  font-size:15px;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="ui">
  <input id="searchInput" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›">
  <button onclick="search()">ğŸ”</button>

  <div id="viewMode">
    <button onclick="setView('2d')">2D</button>
    <button onclick="setView('2dn')">2DN</button>
    <button onclick="setView('3d')">3D</button>
  </div>
</div>

<button id="locBtn" onclick="goCurrent()">âŒ–</button>
<div id="info"></div>

<script>
/* ===== APIã‚­ãƒ¼ ===== */
const ORS_API_KEY = "ã“ã“ã«ã‚ãªãŸã®APIã‚­ãƒ¼";

/* ===== åœ°å›³ ===== */
const map = new maplibregl.Map({
  container:'map',
  style:'https://tiles.openfreemap.org/styles/liberty',
  center:[139.767,35.681],
  zoom:15
});
map.doubleClickZoom.disable();

/* ===== ç¾åœ¨åœ° ===== */
let current=null;
let currentHeading=0;
let viewMode='2d';
let dest=null;
let destMarker=null;
let routeLayerAdded=false;

navigator.geolocation.watchPosition(p=>{
  current=[p.coords.longitude,p.coords.latitude];
  currentHeading=p.coords.heading ?? currentHeading;

  if(viewMode!=='2d'){
    map.easeTo({
      center:current,
      bearing:currentHeading,
      duration:500
    });
  }
},{},{enableHighAccuracy:true});

function goCurrent(){
  if(!current){ alert("ç¾åœ¨åœ°å–å¾—ä¸­â€¦"); return; }
  map.easeTo({center:current,zoom:17});
}

/* ===== è¦–ç‚¹åˆ‡æ›¿ ===== */
function setView(mode){
  viewMode = mode;
  if(mode==='2d'){ map.easeTo({pitch:0,bearing:0,zoom:15,duration:800}); }
  if(mode==='2dn'){ map.easeTo({pitch:0,bearing:currentHeading,zoom:16,duration:800}); }
  if(mode==='3d'){ map.easeTo({pitch:60,bearing:currentHeading,zoom:17,duration:800}); enable3DBuildings(); }
}

/* ===== å»ºç‰©3D ===== */
let buildingsAdded=false;
function enable3DBuildings(){
  if(buildingsAdded) return;
  map.addLayer({
    id:'3d-buildings',
    source:'openmaptiles',
    'source-layer':'building',
    type:'fill-extrusion',
    minzoom:15,
    paint:{
      'fill-extrusion-color':'#aaa',
      'fill-extrusion-height':['get','height'],
      'fill-extrusion-base':['get','min_height'],
      'fill-extrusion-opacity':0.6
    }
  });
  buildingsAdded=true;
}

/* ===== æ¤œç´¢ ===== */
function search(){
  const query = document.getElementById("searchInput").value;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
  .then(r=>r.json())
  .then(d=>{
    if(!d[0]) return alert("è¦‹ã¤ã‹ã‚‰ãªã„ğŸ˜‡");
    dest=[+d[0].lon,+d[0].lat];
    if(destMarker) destMarker.remove();
    destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
    map.easeTo({center:dest,zoom:16});
    calcRoute('foot-walking'); // å¾’æ­©ãƒ‡ãƒ•ã‚©
  });
}

/* ===== ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç›®çš„åœ° ===== */
map.on('dblclick',e=>{
  dest=[e.lngLat.lng,e.lngLat.lat];
  if(destMarker) destMarker.remove();
  destMarker=new maplibregl.Marker({color:'red'}).setLngLat(dest).addTo(map);
  calcRoute('foot-walking');
});

/* ===== éŸ³å£°ãƒŠãƒ“ç”¨é–¢æ•° ===== */
function speak(text){
  if('speechSynthesis' in window){
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang='ja-JP';
    window.speechSynthesis.speak(msg);
  }
}

/* ===== ãƒ«ãƒ¼ãƒˆè¨ˆç®— + 3Dè¡¨ç¤º ===== */
function calcRoute(profile){
  if(!current || !dest) return;
  fetch(`https://api.openrouteservice.org/v2/directions/${profile}`,{
    method:'POST',
    headers:{
      'Authorization':ORS_API_KEY,
      'Content-Type':'application/json'
    },
    body:JSON.stringify({coordinates:[current,dest],alternative_routes:{share_factor:0.6,target_count:2}})
  })
  .then(r=>r.json())
  .then(d=>{
    // ãƒ«ãƒ¼ãƒˆGeoJSON
    const route = d.features[0];
    if(map.getSource('route')){
      map.removeLayer('route'); map.removeSource('route');
    }
    map.addSource('route',{type:'geojson',data:route});
    map.addLayer({
      id:'route', type:'line', source:'route',
      paint:{'line-width':6,'line-color':'#1e90ff'}
    });

    // è·é›¢ãƒ»æ™‚é–“
    const s = route.properties.summary;
    const info = document.getElementById('info');
    info.innerText=`è·é›¢ ${(s.distance/1000).toFixed(1)}km / ç´„ ${Math.round(s.duration/60)}åˆ†`;
    info.style.display='block';

    // éŸ³å£°ãƒŠãƒ“ç”¨
    const coords = route.geometry.coordinates;
    trackPositionForVoice(coords, profile);
  });
}

/* ===== ç¾åœ¨åœ°ã«åˆã‚ã›ã¦éŸ³å£°ãƒŠãƒ“ ===== */
let lastVoiceIndex=-1;
function trackPositionForVoice(coords, mode){
  lastVoiceIndex=-1;
  const interval = setInterval(()=>{
    if(!current) return;
    // æœ€ã‚‚è¿‘ã„æ¬¡ã®åº§æ¨™ã‚’æ¢ã™
    let nextIndex=coords.findIndex((c,i)=>i>lastVoiceIndex && distance(current,c)>0);
    if(nextIndex===-1){ clearInterval(interval); return; }

    const dist = distance(current, coords[nextIndex]);
    if(dist<50 && nextIndex>lastVoiceIndex){ // 50mæ‰‹å‰ã§æ¡ˆå†…
      speak(`${Math.round(dist)}ãƒ¡ãƒ¼ãƒˆãƒ«å…ˆã€æ›²ãŒã‚Šè§’ã§ã™`);
      lastVoiceIndex=nextIndex;
    }
  },1000);
}

/* ===== è·é›¢è¨ˆç®—ï¼ˆçµŒåº¦ç·¯åº¦ï¼‰ ===== */
function distance(a,b){
  const R = 6371000;
  const rad = Math.PI/180;
  const dLat=(b[1]-a[1])*rad;
  const dLon=(b[0]-a[0])*rad;
  const lat1=a[1]*rad, lat2=b[1]*rad;
  const x = dLon*Math.cos((lat1+lat2)/2);
  const y = dLat;
  return Math.sqrt(x*x + y*y)*R;
}
</script>
</body>
</html>

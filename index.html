<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Éä„Éì</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; }
#map { height:100%; }

#searchBox {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:8px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  z-index:10;
  width:90%;
  max-width:400px;
}
#controls {
  display:none;
  margin-top:6px;
  text-align:center;
}
button { margin:2px; }
</style>
</head>

<body>

<div id="searchBox">
  <input id="search" placeholder="‰ΩèÊâÄ„ÇíÂÖ•Âäõ" style="width:100%;font-size:16px;">
  <div id="controls">
    <button onclick="setMode('foot-walking')">üö∂ ÂæíÊ≠©</button>
    <button onclick="setMode('driving-car')">üöó Ëªä</button>
  </div>
</div>

<div id="map"></div>

<script>
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0ZTI4ZDE0Y2I2NTQwNzM5ZWYzMDg5YTBlNmFkNTczIiwiaCI6Im11cm11cjY0In0=";

let map, start, dest, mode="foot-walking", routeId;
let userMarker;

map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center: [139.767, 35.681],
  zoom: 15
});

map.addControl(new maplibregl.NavigationControl());

/* ===== ÁèæÂú®Âú∞ÔºàÁü¢Âç∞Ôºâ ===== */
navigator.geolocation.watchPosition(pos=>{
  start = [pos.coords.longitude, pos.coords.latitude];

  if(!userMarker){
    const el = document.createElement("div");
    el.style.width="20px";
    el.style.height="20px";
    el.style.background="blue";
    el.style.clipPath="polygon(50% 0, 0 100%, 100% 100%)";
    userMarker = new maplibregl.Marker(el).setLngLat(start).addTo(map);
    map.setCenter(start);
  } else {
    userMarker.setLngLat(start);
  }

  if(pos.coords.heading !== null){
    userMarker.getElement().style.transform =
      `rotate(${pos.coords.heading}deg)`;
  }

  if(dest) getRoute();
},{enableHighAccuracy:true});

/* ===== Ê§úÁ¥¢ÔºàNominatimÔºâ ===== */
document.getElementById("search").addEventListener("keydown", async e=>{
  if(e.key!=="Enter") return;
  const q = e.target.value;
  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`
  );
  const data = await res.json();
  if(!data[0]) return alert("Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");

  dest = [Number(data[0].lon), Number(data[0].lat)];
  new maplibregl.Marker({color:"red"}).setLngLat(dest).addTo(map);
  map.flyTo({center:dest, zoom:16});
  document.getElementById("controls").style.display="block";
});

/* ===== „É´„Éº„Éà ===== */
function setMode(m){
  mode=m;
  getRoute();
}

async function getRoute(){
  if(!start||!dest) return;

  if(routeId){
    map.removeLayer(routeId);
    map.removeSource(routeId);
  }

  const res = await fetch(
    `https://api.openrouteservice.org/v2/directions/${mode}/geojson`,
    {
      method:"POST",
      headers:{
        "Authorization":ORS_API_KEY,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({coordinates:[start,dest]})
    }
  );
  const geo = await res.json();

  routeId="route";
  map.addSource(routeId,{type:"geojson",data:geo});
  map.addLayer({
    id:routeId,
    type:"line",
    source:routeId,
    paint:{
      "line-width":6,
      "line-color":"#007aff"
    }
  });
}
</script>
</body>
</html>

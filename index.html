<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒŠãƒ“</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; height:100%; }
#map { height:100%; }

#panel {
  position:absolute;
  top:env(safe-area-inset-top,10px);
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:10px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  z-index:10;
  width:90%;
  max-width:420px;
}

#info {
  font-size:14px;
  margin-top:6px;
}

#controls {
  display:none;
  margin-top:6px;
  text-align:center;
}

button { margin:2px; font-size:15px; }
</style>
</head>

<body>

<div id="panel">
  <input id="search" placeholder="ä½æ‰€ã‚’å…¥åŠ›" style="width:100%;font-size:16px;">
  <div id="controls">
    <button onclick="setMode('foot-walking')">ðŸš¶ å¾’æ­©</button>
    <button onclick="setMode('driving-car')">ðŸš— è»Š</button>
  </div>
  <div id="info"></div>
</div>

<div id="map"></div>

<script>
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0ZTI4ZDE0Y2I2NTQwNzM5ZWYzMDg5YTBlNmFkNTczIiwiaCI6Im11cm11cjY0In0=";

let map, start, dest, mode="foot-walking";
let userMarker, destMarker;
let routeSources = [];
let activeRoute = 0;

map = new maplibregl.Map({
  container:'map',
  style:'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center:[139.767,35.681],
  zoom:15
});

map.doubleClickZoom.disable();
map.addControl(new maplibregl.NavigationControl());

/* ==== ç¾åœ¨åœ°ï¼ˆçŸ¢å°ï¼‰ ==== */
navigator.geolocation.watchPosition(pos=>{
  start=[pos.coords.longitude,pos.coords.latitude];

  if(!userMarker){
    const el=document.createElement("div");
    el.style.width="22px";
    el.style.height="22px";
    el.style.background="#007aff";
    el.style.clipPath="polygon(50% 0, 0 100%, 100% 100%)";
    userMarker=new maplibregl.Marker(el).setLngLat(start).addTo(map);
    map.setCenter(start);
  } else {
    userMarker.setLngLat(start);
  }

  map.easeTo({
    center:start,
    bearing:pos.coords.heading||map.getBearing(),
    duration:500
  });

  if(dest) getRoute();
},{enableHighAccuracy:true});

/* ==== æ¤œç´¢ ==== */
search.addEventListener("keydown",async e=>{
  if(e.key!=="Enter")return;
  const q=e.target.value;
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
  const d=await r.json();
  if(!d[0])return alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

  setDestination([+d[0].lon,+d[0].lat]);
});

/* ==== åœ°å›³2å›žã‚¿ãƒƒãƒ— ==== */
let tap=0,timer;
map.on("click",e=>{
  tap++; clearTimeout(timer);
  timer=setTimeout(()=>tap=0,300);
  if(tap===2) setDestination([e.lngLat.lng,e.lngLat.lat]);
});

function setDestination(p){
  dest=p;
  if(destMarker) destMarker.setLngLat(dest);
  else destMarker=new maplibregl.Marker({color:"red"}).setLngLat(dest).addTo(map);
  map.flyTo({center:dest,zoom:16});
  controls.style.display="block";
  getRoute();
}

/* ==== ãƒ«ãƒ¼ãƒˆå–å¾—ï¼ˆè¤‡æ•°ï¼‰ ==== */
function setMode(m){ mode=m; getRoute(); }

async function getRoute(){
  if(!start||!dest) return;

  routeSources.forEach(id=>{
    if(map.getLayer(id))map.removeLayer(id);
    if(map.getSource(id))map.removeSource(id);
  });
  routeSources=[];

  const res=await fetch(
    `https://api.openrouteservice.org/v2/directions/${mode}/geojson`,
    {
      method:"POST",
      headers:{
        "Authorization":ORS_API_KEY,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        coordinates:[start,dest],
        alternative_routes:{target_count:3}
      })
    }
  );
  const data=await res.json();

  data.features.forEach((f,i)=>{
    const id="route"+i;
    map.addSource(id,{type:"geojson",data:f});
    map.addLayer({
      id,
      type:"line",
      source:id,
      paint:{
        "line-width": i===0?6:4,
        "line-color": i===0?"#007aff":"#aaa"
      }
    });
    map.on("click",id,()=>selectRoute(i));
    routeSources.push(id);
  });

  selectRoute(0);
}

function selectRoute(i){
  activeRoute=i;
  routeSources.forEach((id,idx)=>{
    map.setPaintProperty(id,"line-color",idx===i?"#007aff":"#aaa");
    map.setPaintProperty(id,"line-width",idx===i?6:4);
  });

  const f=map.getSource(routeSources[i])._data.features[0];
  const d=f.properties.summary;
  info.textContent=`æ®‹ã‚Š ${Math.round(d.distance/100)/10}km / ç´„ ${Math.round(d.duration/60)}åˆ†`;
}
</script>
</body>
</html>
